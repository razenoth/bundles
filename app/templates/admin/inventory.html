{% extends 'base.html' %}
{% block content %}
<h1>Inventory Mirror</h1>
<p>Last DB Pull: <span id="last-sync">{{ last }}</span> (<span id="last-count">{{ count }}</span> items)</p>
<button id="sync-btn" class="btn btn-primary">Update now</button>
<button id="csv-btn" class="btn btn-secondary ms-2">Open DB CSV</button>
<div id="status" class="mt-2"></div>
<script>
const SECRET = '{{ secret }}';
const btn = document.getElementById('sync-btn');
const csvBtn = document.getElementById('csv-btn');
const statusEl = document.getElementById('status');
async function check() {
  const res = await fetch('/admin/inventory/status', {headers:{'X-Admin-Secret':SECRET}});
  const data = await res.json();
  document.getElementById('last-sync').textContent = data.last_synced_at || 'never';
  document.getElementById('last-count').textContent = data.last_synced_count || '0';
  if (data.running === "1") {
    if (data.state === 'waiting') {
      statusEl.textContent = 'Waiting for rate limit...';
    } else {
      statusEl.textContent = 'Getting information from RepairShopr...';
    }
    btn.disabled = true;
    setTimeout(check, 3000);
  } else {
    btn.disabled = false;
    if (data.last_error) {
      statusEl.textContent = data.last_error;
    } else if (data.state === 'completed') {
      statusEl.textContent = 'Finished fetching.';
    } else {
      statusEl.textContent = '';
    }
  }
}
btn.addEventListener('click', async () => {
  btn.disabled = true;
  await fetch('/admin/inventory/sync', {method:'POST', headers:{'X-Admin-Secret':SECRET}});
  check();
});
csvBtn.addEventListener('click', async () => {
  const res = await fetch('/admin/inventory/products.csv', {headers:{'X-Admin-Secret':SECRET}});
  const blob = await res.blob();
  const url = URL.createObjectURL(blob);
  window.open(url, '_blank');
});
check();
</script>
{% endblock %}
