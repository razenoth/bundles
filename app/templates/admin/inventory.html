{% extends 'base.html' %}
{% block content %}
<h1>Inventory Mirror</h1>
<p>Last DB Pull: <span id="last-sync">{{ last }}</span></p>
<button id="sync-btn" class="btn btn-primary">Run manual update</button>
<div id="status" class="mt-2"></div>

<table class="table mt-4">
  <thead><tr><th>ID</th><th>Name</th><th>Qty</th></tr></thead>
  <tbody id="prod-body"></tbody>
</table>
<script>
const SECRET = '{{ secret }}';
const btn = document.getElementById('sync-btn');
const statusEl = document.getElementById('status');
const prodBody = document.getElementById('prod-body');
async function check() {
  const res = await fetch('/admin/inventory/status', {headers:{'X-Admin-Secret':SECRET}});
  const data = await res.json();
  document.getElementById('last-sync').textContent = data.last_synced_at || 'never';
  if (data.running) {
    statusEl.textContent = 'Sync running...';
    btn.disabled = true;
    setTimeout(check, 3000);
  } else {
    statusEl.textContent = '';
    btn.disabled = false;
    loadProducts();
  }
}
btn.addEventListener('click', async () => {
  btn.disabled = true;
  await fetch('/admin/inventory/sync', {method:'POST', headers:{'X-Admin-Secret':SECRET}});
  check();
});
async function loadProducts(){
  const res = await fetch('/admin/inventory/products', {headers:{'X-Admin-Secret':SECRET}});
  const data = await res.json();
  prodBody.innerHTML = data.products.map(p=>`<tr><td>${p.id}</td><td>${p.name}</td><td>${p.quantity}</td></tr>`).join('');
}
check();
loadProducts();
</script>
{% endblock %}
