{% extends 'base.html' %}
{% block content %}
<div class="container mt-4" data-estimate-id="{{ estimate.id if estimate else '' }}">
  <h1>
    {% if estimate %}Edit Estimate #{{ estimate.id }}
    {% else %}New Estimate{% endif %}
  </h1>
  <div class="mb-3 position-relative">
    <label for="customer-search">Customer</label>
    <input type="hidden" id="customer-id" value="{{ estimate.customer_id or '' }}">
    <input type="text" id="customer-search" class="form-control"
           placeholder="Search RepairShopr customers" autocomplete="off"
           value="{{ estimate.customer_name or '' }}">
    <ul id="customer-suggestions" class="list-group position-absolute w-100"
        style="z-index:1000;"></ul>
  </div>
  <div class="mb-3">
    <strong>Address:</strong>
    <div id="customer-address">{{ estimate.customer_address or '' }}</div>
  </div>
  <div class="mb-3">
    <label for="status">Status</label>
    <select id="status" class="form-select">
      {% for st in ['draft', 'sent'] %}
      <option value="{{ st }}" {% if estimate.status == st %}selected{% endif %}>{{ st.title() }}</option>
      {% endfor %}
    </select>
  </div>

  <hr>

  <!-- Bundle search -->
  <div class="mb-4 position-relative">
    <label for="bundle-search">Add Bundle</label>
    <input
      type="text"
      id="bundle-search"
      class="form-control"
      placeholder="Search saved bundles"
      autocomplete="off"
    >
    <ul
      id="bundle-suggestions"
      class="list-group position-absolute w-100"
      style="z-index:1000;"
    ></ul>
  </div>

  <!-- Product search -->
  <div class="mb-4 position-relative">
    <label for="product-search">Add Product</label>
    <input type="text" id="product-search" class="form-control"
           placeholder="Search RepairShopr products" autocomplete="off">
    <ul
      id="product-suggestions"
      class="list-group position-absolute w-100"
      style="z-index:1000;"
    ></ul>
  </div>

  <!-- Line items with drag-and-drop -->
  <table class="table table-striped mt-3" id="items-table">
    <thead>
      <tr>
        <th></th>
        <th>Product</th>
        <th>Description</th>
        <th>Cost ($)</th>
        <th>Retail ($)</th>
        <th style="width:80px;">Qty</th>
        <th>Stock</th>
        <th>Total</th>
        <th></th>
      </tr>
    </thead>
    <tbody id="items-body">
      {% if items %}
        {% for it in items %}
        <tr data-item-id="{{ it.id }}" data-type="{{ it.type }}" data-qty="{{ it.quantity }}" class="draggable{% if it.type=='product' and (it.stock or 0) > 0 and (it.stock or 0) < it.quantity %} table-danger{% endif %}" draggable="true">
          <td>☰</td>
          <td>
            {% if it.type=='bundle' %}
            <input type="text" class="form-control item-name" value="{{ it.name }}">
            {% else %}
            {{ it.name }}
            {% endif %}
          </td>
          <td>
            {% if it.type=='bundle' %}
            <input type="text" class="form-control item-desc" value="{{ it.description or '' }}">
            {% else %}
            {{ it.description or '' }}
            {% endif %}
          </td>
          <td>
            <div class="input-group">
              <span class="input-group-text">$</span>
              <input type="number" class="form-control unit-price" step="0.01" value="{{ it.unit_price }}"{% if it.type=='bundle' %} readonly{% endif %}>
            </div>
          </td>
          <td>
            <div class="input-group">
              <span class="input-group-text">$</span>
              <input type="number" class="form-control retail" step="0.01" value="{{ it.retail }}"{% if it.type=='bundle' %} readonly{% endif %}>
            </div>
          </td>
          <td><input type="number" class="form-control qty" value="{{ it.quantity }}" min="0" style="width:80px;"></td>
          <td class="stock-cell">{% if it.type=='product' %}{{ it.stock or 0 }}{% else %}--{% endif %}</td>
          <td class="line-total{% if it.type=='product' and (it.stock or 0) <= 0 %} bg-danger text-white{% endif %}">${{ '%.2f'|format(it.quantity * it.retail) }}</td>
          <td>
            <button class="btn btn-sm btn-danger remove-item">✕</button>
            {% if it.type=='bundle' %}
            <button class="btn btn-sm btn-outline-primary toggle-bundle ms-1" title="Show/Hide Items">&#128065;</button>
            {% endif %}
          </td>
        </tr>
        {% if it.type=='bundle' %}
        {% for sub in it.children %}
        <tr data-parent-id="{{ it.id }}" data-type="product" data-qty="{{ sub.quantity }}" class="bundle-item draggable{% if (sub.stock or 0) > 0 and (sub.stock or 0) < sub.quantity %} table-danger{% endif %}" draggable="true">
          <td>—</td>
          <td class="ps-4">{{ sub.name }}</td>
          <td>{{ sub.description or '' }}</td>
          <td>
            <div class="input-group">
              <span class="input-group-text">$</span>
              <input type="number" class="form-control unit-price" step="0.01" value="{{ sub.unit_price }}">
            </div>
          </td>
          <td>
            <div class="input-group">
              <span class="input-group-text">$</span>
              <input type="number" class="form-control retail" step="0.01" value="{{ sub.retail }}">
            </div>
          </td>
          <td><input type="number" class="form-control qty" value="{{ sub.quantity }}" min="0" style="width:80px;"></td>
          <td class="stock-cell">{{ sub.stock or 0 }}</td>
          <td class="line-total{% if (sub.stock or 0) <= 0 %} bg-danger text-white{% endif %}">${{ '%.2f'|format(sub.quantity * sub.retail) }}</td>
          <td></td>
        </tr>
        {% endfor %}
        {% endif %}
        {% endfor %}
      {% endif %}
    </tbody>
  </table>

  <div class="row mt-4" id="estimate-summary">
    <div class="col-md mb-2">
      <div class="border rounded p-2 text-center bg-light">
        <div class="fw-bold">Total Cost</div>
        <div>$<span id="total-cost">{{ '%.2f'|format(total_cost or 0) }}</span></div>
      </div>
    </div>
    <div class="col-md mb-2">
      <div class="border rounded p-2 text-center bg-light">
        <div class="fw-bold">Total Retail</div>
        <div>$<span id="total-retail">{{ '%.2f'|format(total_retail or 0) }}</span></div>
      </div>
    </div>
    <div class="col-md mb-2">
      <div class="border rounded p-2 text-center bg-light">
        <div class="fw-bold">Profit</div>
        <div>$<span id="total-profit">{{ '%.2f'|format((total_retail or 0) - (total_cost or 0)) }}</span></div>
      </div>
    </div>
    <div class="col-md mb-2">
      <div class="border rounded p-2 text-center bg-light">
        <div class="fw-bold">Margin</div>
        <div><span id="margin-percent">
          {% if total_retail %}
            {{ '%.2f'|format(((total_retail - total_cost) / total_retail) * 100) }}%
          {% else %}
            0.00%
          {% endif %}
        </span></div>
      </div>
    </div>
    <div class="col-md mb-2">
      <div class="border rounded p-2 text-center bg-light">
        <div class="fw-bold">Markup</div>
        <div><span id="markup-percent">
          {% if total_cost %}
            {{ '%.2f'|format(((total_retail - total_cost) / total_cost) * 100) }}%
          {% else %}
            0.00%
          {% endif %}
        </span></div>
      </div>
    </div>
  </div>

  <!-- Save/Export/Push buttons unchanged -->
  <div class="mt-3">
    <button id="save-estimate" class="btn btn-primary">Save Estimate</button>
    <button id="update-estimate" class="btn btn-secondary ms-2" title="Updates the cost of each item in the estimate">Update Estimate</button>
    <button id="export-pdf"   class="btn btn-outline-secondary">Export PDF</button>
    <button id="push-rs"      class="btn btn-outline-info">Push to RepairShopr</button>
  </div>
</div>

<script src="{{ url_for('static', filename='js/estimates.js') }}"></script>
{% endblock %}
